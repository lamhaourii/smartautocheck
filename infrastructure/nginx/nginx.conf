# ============================================================================
# Nginx Load Balancer Configuration for SmartAutoCheck
# Pattern: Load Balancing for horizontal scalability
# Purpose: Distribute traffic across multiple API Gateway instances
# ============================================================================

events {
    worker_connections 1024;
}

http {
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Upstream: API Gateway instances (supports multiple replicas)
    # When scaling: docker-compose up --scale api-gateway=3
    # Nginx will automatically distribute traffic round-robin
    upstream api_gateway {
        least_conn;  # Use least connections algorithm for better distribution
        
        # Docker will resolve this to all running api-gateway containers
        server api-gateway:3000 max_fails=3 fail_timeout=30s;
        
        # Health check configuration
        keepalive 32;
    }

    # Rate limiting zone (additional layer on top of Redis-based limiting)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # Increase timeouts for long-running operations
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffer settings
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Enable gzip compression
        gzip on;
        gzip_types application/json text/plain text/css application/javascript;
        gzip_min_length 1000;

        # Security headers
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";

        # Health check endpoint (bypass load balancer)
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # API Routes - Load balanced to API Gateway instances
        location /api/ {
            # Apply rate limiting
            limit_req zone=api_limit burst=20 nodelay;

            # Forward to API Gateway upstream
            proxy_pass http://api_gateway;
            
            # Preserve client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Enable HTTP/1.1 and keep-alive
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Distributed Tracing: Pass trace headers
            proxy_set_header X-B3-TraceId $http_x_b3_traceid;
            proxy_set_header X-B3-SpanId $http_x_b3_spanid;
            proxy_set_header X-B3-ParentSpanId $http_x_b3_parentspanid;
            proxy_set_header X-B3-Sampled $http_x_b3_sampled;
        }

        # WebSocket support for real-time updates
        location /ws/ {
            proxy_pass http://api-gateway:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # WebSocket timeout (1 hour)
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        # Monitoring endpoints
        location /nginx-status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
    }
}

# ============================================================================
# Load Balancing Algorithm: Least Connections
# - Distributes traffic to the server with fewest active connections
# - Better than round-robin for varying request durations
# - Ideal for microservices with mixed workload
#
# Horizontal Scaling Demo:
# 1. Start with 1 gateway: docker-compose up
# 2. Scale to 3: docker-compose up --scale api-gateway=3
# 3. Nginx automatically distributes traffic
# 4. Check distribution: curl http://localhost/api/health (multiple times)
#
# Benefits:
# - High availability: if one gateway fails, others handle traffic
# - Increased throughput: parallel request processing
# - Zero-downtime deployments: rolling updates possible
# ============================================================================
